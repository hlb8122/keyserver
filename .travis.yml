language: rust
rust:
  - stable

cache: cargo
before_install:
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt update; fi
  - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sudo apt install -y pkg-config libzmq3-dev libssl-dev; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then choco install pkgconfiglite; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then wget https://s3-us-west-2.amazonaws.com/ai.bonsai.chocolatey-hosting/ZeroMQ-4.0.4~miru1.0-x64.exe; fi
  - if [ "$TRAVIS_OS_NAME" = "windows" ]; then ZeroMQ-4.0.4~miru1.0-x64.exe; fi

  
jobs:
  include:
  - stage: build-linux
    os: linux
    dist: xenial
    script:
      cargo build --verbose
  - stage: build-windows
    os: windows
    script:
      cargo build --verbose
  - stage: unittest-linux
    os: linux
    dist: xenial
    script:
    - cargo test bitcoin
    - cargo test crypto
    - cargo test db
  - stage: unittest-windows
    os: windows
    script:
    - cargo test bitcoin
    - cargo test crypto
    - cargo test db
  - stage: regtest-linux
    os: linux
    dist: xenial
    script:
    - sudo add-apt-repository -y ppa:bitcoin-abc/ppa
    - sudo apt-get update
    - sudo apt install -y libzmq3-dev
    - sudo apt install -y bitcoind
    - bitcoind -daemon -regtest -zmqpubrawtx=tcp://127.0.0.1:28332 -rpcallowip=0.0.0.0/0 -server -rpcuser=username -rpcpassword=password
    - sleep 30
    - bitcoin-cli -regtest -rpcuser=username -rpcpassword=password generate 101
    - cargo test
